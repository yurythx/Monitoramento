# =========================================================
# SISTEMA DE BACKUP AUTOMATIZADO - PROJETO MONITORAMENTO
# =========================================================
# Descri√ß√£o: Sistema de backup di√°rio automatizado para configura√ß√µes
#            e dados do projeto Monitoramento (GLPI, Zabbix, Grafana)
# Frequ√™ncia: Di√°ria (24h)
# Reten√ß√£o: 30 dias
# Formato: .tar.gz compactado
# Localiza√ß√£o: /mnt/backup/monitoramento/
# Conte√∫do: Volumes Docker dos servi√ßos de monitoramento
# =========================================================

services:
  backup-monitoramento:
    image: alpine:latest
    container_name: backup-monitoramento
    restart: unless-stopped
    
    # Configura√ß√µes de timezone
    environment:
      - TZ=America/Sao_Paulo
      - BACKUP_INTERVAL=86400  # 24 horas em segundos
      - BACKUP_RETENTION=30    # Manter backups por 30 dias
      - PROJECT_NAME=monitoramento
    
    # Mapeamento de volumes
    volumes:
      # Volumes dos servi√ßos (somente leitura para backup)
      - glpi_db_data:/backup/source/glpi_db_data:ro
      - glpi_files:/backup/source/glpi_files:ro
      - zabbix_db_data:/backup/source/zabbix_db_data:ro
      - grafana_data:/backup/source/grafana_data:ro
      
      # Diret√≥rio de destino dos backups
      - /mnt/backup/monitoramento:/backup/destination
      
      # Script opcional (removido: arquivo ausente)
    
    # Comando de inicializa√ß√£o
    command: >
      sh -c "
        echo '=== SISTEMA DE BACKUP MONITORAMENTO INICIADO ===' &&
        echo 'Projeto: Monitoramento (GLPI + Zabbix + Grafana)' &&
        echo 'Frequ√™ncia: Di√°ria (24h)' &&
        echo 'Reten√ß√£o: 30 dias' &&
        echo 'Destino: /mnt/backup/monitoramento/' &&
        echo '=================================================' &&
        
        # Instalar depend√™ncias
        apk add --no-cache tar gzip coreutils findutils &&
        
        # Criar diret√≥rio de backup se n√£o existir
        mkdir -p /backup/destination &&
        
        # Loop infinito para backups peri√≥dicos
        while true; do
          echo '' &&
          echo '[$(date)] === INICIANDO BACKUP MONITORAMENTO ===' &&
          
          # Definir nome do arquivo de backup
          BACKUP_DATE=$(date +%Y%m%d_%H%M%S) &&
          BACKUP_FILE=\"monitoramento_backup_$${BACKUP_DATE}.tar.gz\" &&
          BACKUP_PATH=\"/backup/destination/$${BACKUP_FILE}\" &&
          
          echo '[$(date)] Criando backup: $${BACKUP_FILE}' &&
          
          # Criar backup compactado
          cd /backup/source &&
          if [ -d glpi_db_data ] && [ -d glpi_files ] && [ -d zabbix_db_data ] && [ -d grafana_data ]; then
            tar -czf \"$${BACKUP_PATH}\" \
              glpi_db_data/ \
              glpi_files/ \
              zabbix_db_data/ \
              grafana_data/ \
              2>/dev/null
          else
            echo '[$(date)] ‚ö†Ô∏è AVISO: Alguns volumes n√£o est√£o dispon√≠veis. Criando backup dos volumes existentes...' &&
            tar -czf \"$${BACKUP_PATH}\" \
              $(find . -maxdepth 1 -type d -name '*data*' -o -name '*files*' 2>/dev/null | head -10) \
              2>/dev/null || echo '[$(date)] ‚ÑπÔ∏è Backup vazio criado (volumes n√£o populados)'
          fi &&
          
          # Verificar se o backup foi criado com sucesso
          if [ -f \"$${BACKUP_PATH}\" ]; then
            BACKUP_SIZE=$(du -h \"$${BACKUP_PATH}\" | cut -f1) &&
            echo '[$(date)] ‚úÖ Backup criado com sucesso!' &&
            echo '[$(date)] üìÅ Arquivo: $${BACKUP_FILE}' &&
            echo '[$(date)] üìä Tamanho: $${BACKUP_SIZE}' &&
            
            # Verificar integridade do backup
            echo '[$(date)] üîç Verificando integridade...' &&
            if tar -tzf \"$${BACKUP_PATH}\" >/dev/null 2>&1; then
              echo '[$(date)] ‚úÖ Integridade verificada com sucesso!' &&
              
              # Remover backups antigos (manter apenas os √∫ltimos 30 dias)
              echo '[$(date)] üßπ Removendo backups antigos...' &&
              find /backup/destination -name \"monitoramento_backup_*.tar.gz\" -type f -mtime +$${BACKUP_RETENTION} -delete &&
              
              # Contar backups restantes
              BACKUP_COUNT=$(find /backup/destination -name \"monitoramento_backup_*.tar.gz\" -type f | wc -l) &&
              echo '[$(date)] üìà Total de backups mantidos: $${BACKUP_COUNT}' &&
              echo '[$(date)] ‚úÖ Backup conclu√≠do com sucesso!' &&
              echo '[$(date)] ‚è∞ Pr√≥ximo backup em: $${BACKUP_INTERVAL} segundos (24h)'
            else
              echo '[$(date)] ‚ùå ERRO: Backup corrompido detectado!' &&
              rm -f \"$${BACKUP_PATH}\" &&
              echo '[$(date)] üóëÔ∏è Backup corrompido removido'
            fi
          else
            echo '[$(date)] ‚ùå ERRO: Falha ao criar backup!'
          fi &&
          
          echo '[$(date)] === BACKUP MONITORAMENTO FINALIZADO ===' &&
          echo '' &&
          
          # Aguardar pr√≥ximo ciclo
          sleep $${BACKUP_INTERVAL}
        done
      "
    
    # Health check
    healthcheck:
      test: ["CMD", "sh", "-c", "find /backup/destination -name 'monitoramento_backup_*.tar.gz' -mtime -2 | grep -q ."]
      interval: 1h
      timeout: 30s
      retries: 3
      start_period: 5m
    
    # Rede compartilhada
    networks:
      - itsm_shared_net
    
    # Labels para organiza√ß√£o
    labels:
      - "com.projeto.monitoramento.backup=true"
      - "com.projeto.monitoramento.service=backup"
      - "com.projeto.monitoramento.version=1.0"

# Definir volumes externos (referenciando os volumes dos servi√ßos)
volumes:
  glpi_db_data:
  glpi_files:
  zabbix_db_data:
  grafana_data:

networks:
  itsm_shared_net:
    external: true
